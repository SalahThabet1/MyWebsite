---
// inspired by: https://github.com/antfu/antfu.me/blob/main/src/components/ArtDots.vue
---

<bg-dot
  class="z--1 fixed inset-0 pointer-events-none print:hidden"
  style="mix-blend-mode:screen"
></bg-dot>

<script>
  import p5 from 'p5'
  import type { default as P5Instance } from 'p5'

  class BgDotElement extends HTMLElement {
    p5Instance: P5Instance | null

    constructor() {
      super()
      this.p5Instance = null
    }

    connectedCallback() {
      const sketch = (p: P5Instance) => {
        // Dynamic, theme-aware point field.
        const SCALE = 200
        const LENGTH = 10
        const SPACING = 15
        const FADE_ALPHA = 16 // background trail alpha (0-255)

        const width = window.innerWidth
        const height = window.innerHeight

        const existingPoints = new Set()
        const points: { x: number; y: number; opacity: number }[] = []

        function getForceOnPoint(x: number, y: number, z: number) {
          return (p.noise(x / SCALE, y / SCALE, z) - 0.5) * 2 * p.TWO_PI
        }

        function getLength(x: number, y: number, t: number) {
          return (p.noise(x / SCALE, y / SCALE, t * 2) + 0.5) * LENGTH
        }

        function addPoints() {
          for (let x = -SPACING / 2; x < width + SPACING; x += SPACING) {
            for (let y = -SPACING / 2; y < height + SPACING; y += SPACING) {
              const id = `${x}-${y}`
              if (existingPoints.has(id)) continue
              existingPoints.add(id)
              points.push({ x, y, opacity: Math.random() * 0.5 + 0.5 })
            }
          }
        }

        const host = this as HTMLElement
        const getBgColor = () => {
          const raw = getComputedStyle(document.documentElement)
            .getPropertyValue('--c-bg')
            .trim() || '#ffffff'
          const hex = raw.startsWith('#') ? raw.slice(1) : raw
          const full = hex.length === 3 ? hex.split('').map(c=>c+c).join('') : hex
          return {
            r: parseInt(full.slice(0,2),16),
            g: parseInt(full.slice(2,4),16),
            b: parseInt(full.slice(4,6),16),
          }
        }
        let bg = getBgColor()
        const lum = (c: {r:number;g:number;b:number}) => (0.2126*c.r + 0.7152*c.g + 0.0722*c.b)/255
        const isDark = () => lum(bg) < 0.5

        const updateBlend = () => {
          host.style.mixBlendMode = isDark() ? 'screen' : 'multiply'
        }
        setInterval(() => { bg = getBgColor(); updateBlend() }, 2500)
        updateBlend()

        p.setup = () => {
          p.createCanvas(width, height)
          p.frameRate(30)
          addPoints()
        }

        p.draw = () => {
          // Soft trail fade using theme background color.
          p.noStroke()
          p.fill(bg.r, bg.g, bg.b, FADE_ALPHA)
          p.rect(0,0,width,height)

          const t = Date.now() / 10000
          const dark = isDark()
          for (const point of points) {
            const { x, y } = point
            const rad = getForceOnPoint(x, y, t)
            const length = getLength(x, y, t)
            const nx = x + p.cos(rad) * length
            const ny = y + p.sin(rad) * length
            const variance = (Math.abs(p.cos(rad)) * 0.6 + 0.4) * point.opacity
            const tone = dark ? 235 : 55
            const alphaCore = variance * (dark ? 180 : 210)
            const alphaGlow = alphaCore * 0.35
            // Glow
            p.stroke(tone, tone, tone, alphaGlow)
            p.strokeWeight(5)
            p.point(nx, ny)
            // Core
            p.stroke(tone, tone, tone, alphaCore)
            p.strokeWeight(2)
            p.point(nx, ny)
          }
        }
      }

      this.p5Instance = new p5(sketch, this)
    }

    // after switching pages, stop the animation loop
    disconnectedCallback() {
      if (this.p5Instance) {
        this.p5Instance.remove()
        this.p5Instance = null
      }
    }
  }

  customElements.define('bg-dot', BgDotElement)
</script>
